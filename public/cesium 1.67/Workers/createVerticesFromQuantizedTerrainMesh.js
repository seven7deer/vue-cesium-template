/**
 * Cesium - https://github.com/CesiumGS/cesium
 *
 * Copyright 2011-2020 Cesium Contributors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Columbus View (Pat. Pend.)
 *
 * Portions licensed separately.
 * See https://github.com/CesiumGS/cesium/blob/master/LICENSE.md for full licensing details.
 */
define(["./when-a55a8a4c","./Check-bc1d37d9","./Math-d7cbfcf6","./Cartesian2-6ec3db89","./Transforms-a4d7073e","./RuntimeError-7c184ac0","./WebGLConstants-4c11ee5f","./ComponentDatatype-919a7463","./AttributeCompression-6cfb9427","./IndexDatatype-4351ba4c","./IntersectionTests-3d9e1b94","./Plane-37b84dad","./WebMercatorProjection-e471eea5","./createTaskProcessorWorker","./EllipsoidTangentPlane-323c7a98","./OrientedBoundingBox-764de7b5","./TerrainEncoding-69e30123"],function(Te,g,pe,Ee,fe,e,t,r,ve,ye,i,n,we,o,Ne,be,Me){"use strict";function xe(){g.DeveloperError.throwInstantiationError()}Object.defineProperties(xe.prototype,{errorEvent:{get:g.DeveloperError.throwInstantiationError},credit:{get:g.DeveloperError.throwInstantiationError},tilingScheme:{get:g.DeveloperError.throwInstantiationError},ready:{get:g.DeveloperError.throwInstantiationError},readyPromise:{get:g.DeveloperError.throwInstantiationError},hasWaterMask:{get:g.DeveloperError.throwInstantiationError},hasVertexNormals:{get:g.DeveloperError.throwInstantiationError},availability:{get:g.DeveloperError.throwInstantiationError}});var a=[];xe.getRegularGridIndices=function(e,t){if(e*t>=pe.CesiumMath.FOUR_GIGABYTES)throw new g.DeveloperError("The total number of vertices (width * height) must be less than 4,294,967,296.");var r=a[e];Te.defined(r)||(a[e]=r=[]);var i=r[t];return Te.defined(i)||E(e,t,i=e*t<pe.CesiumMath.SIXTY_FOUR_KILOBYTES?r[t]=new Uint16Array((e-1)*(t-1)*6):r[t]=new Uint32Array((e-1)*(t-1)*6),0),i};var c=[];xe.getRegularGridIndicesAndEdgeIndices=function(e,t){if(e*t>=pe.CesiumMath.FOUR_GIGABYTES)throw new g.DeveloperError("The total number of vertices (width * height) must be less than 4,294,967,296.");var r=c[e];Te.defined(r)||(c[e]=r=[]);var i=r[t];if(!Te.defined(i)){var n=xe.getRegularGridIndices(e,t),o=p(e,t),a=o.westIndicesSouthToNorth,s=o.southIndicesEastToWest,d=o.eastIndicesNorthToSouth,h=o.northIndicesWestToEast;i=r[t]={indices:n,westIndicesSouthToNorth:a,southIndicesEastToWest:s,eastIndicesNorthToSouth:d,northIndicesWestToEast:h}}return i};var T=[];function p(e,t){var r,i=new Array(t),n=new Array(e),o=new Array(t),a=new Array(e);for(r=0;r<e;++r)n[a[r]=r]=e*t-1-r;for(r=0;r<t;++r)o[r]=(r+1)*e-1,i[r]=(t-r-1)*e;return{westIndicesSouthToNorth:i,southIndicesEastToWest:n,eastIndicesNorthToSouth:o,northIndicesWestToEast:a}}function E(e,t,r,i){for(var n=0,o=0;o<t-1;++o){for(var a=0;a<e-1;++a){var s=n+e,d=s+1,h=n+1;r[i++]=n,r[i++]=s,r[i++]=h,r[i++]=h,r[i++]=s,r[i++]=d,++n}++n}}function d(e,t,r,i){for(var n=e[0],o=e.length,a=1;a<o;++a){var s=e[a];r[i++]=n,r[i++]=s,r[i++]=t,r[i++]=t,r[i++]=s,r[i++]=t+1,n=s,++t}return i}xe.getRegularGridAndSkirtIndicesAndEdgeIndices=function(e,t){if(e*t>=pe.CesiumMath.FOUR_GIGABYTES)throw new g.DeveloperError("The total number of vertices (width * height) must be less than 4,294,967,296.");var r=T[e];Te.defined(r)||(T[e]=r=[]);var i=r[t];if(!Te.defined(i)){var n=e*t,o=(e-1)*(t-1)*6,a=2*e+2*t,s=n+a,d=o+6*Math.max(0,a-4),h=p(e,t),c=h.westIndicesSouthToNorth,u=h.southIndicesEastToWest,l=h.eastIndicesNorthToSouth,I=h.northIndicesWestToEast,m=ye.IndexDatatype.createTypedArray(s,d);E(e,t,m,0),xe.addSkirtIndices(c,u,l,I,n,m,o),i=r[t]={indices:m,westIndicesSouthToNorth:c,southIndicesEastToWest:u,eastIndicesNorthToSouth:l,northIndicesWestToEast:I,indexCountWithoutSkirts:o}}return i},xe.addSkirtIndices=function(e,t,r,i,n,o,a){var s=n;a=d(e,s,o,a),a=d(t,s+=e.length,o,a),a=d(r,s+=t.length,o,a),d(i,s+=r.length,o,a)},xe.heightmapTerrainQuality=.25,xe.getEstimatedLevelZeroGeometricErrorForAHeightmap=function(e,t,r){return 2*e.maximumRadius*Math.PI*xe.heightmapTerrainQuality/(t*r)},xe.prototype.requestTileGeometry=g.DeveloperError.throwInstantiationError,xe.prototype.getLevelMaximumGeometricError=g.DeveloperError.throwInstantiationError,xe.prototype.getTileDataAvailable=g.DeveloperError.throwInstantiationError,xe.prototype.loadTileDataAvailability=g.DeveloperError.throwInstantiationError;var Ce=32767,Se=new Ee.Cartesian3,Ae=new Ee.Cartesian3,Pe=new Ee.Cartesian3,We=new Ee.Cartographic,De=new Ee.Cartesian2,Be=new Ee.Cartesian3,Fe=new fe.Matrix4,Ge=new fe.Matrix4;function ke(e,t,r,i,n,o,a,s,d){var h=Number.POSITIVE_INFINITY,c=n.north,u=n.south,l=n.east,I=n.west;l<I&&(l+=pe.CesiumMath.TWO_PI);for(var m=e.length,g=0;g<m;++g){var T=e[g],p=r[T],E=i[T];We.longitude=pe.CesiumMath.lerp(I,l,E.x),We.latitude=pe.CesiumMath.lerp(u,c,E.y),We.height=p-t;var f=o.cartographicToCartesian(We,Se);fe.Matrix4.multiplyByPoint(a,f,f),Ee.Cartesian3.minimumByComponent(f,s,s),Ee.Cartesian3.maximumByComponent(f,d,d),h=Math.min(h,We.height)}return h}function _e(e,t,r,i,n,o,a,s,d,h,c,u,l,I,m){var g=Te.defined(a),T=d.north,p=d.south,E=d.east,f=d.west;E<f&&(E+=pe.CesiumMath.TWO_PI);for(var v=r.length,y=0;y<v;++y){var w=r[y],N=n[w],b=o[w];We.longitude=pe.CesiumMath.lerp(f,E,b.x)+I,We.latitude=pe.CesiumMath.lerp(p,T,b.y)+m,We.height=N-h;var M,x=s.cartographicToCartesian(We,Se);if(g){var C=2*w;if(De.x=a[C],De.y=a[1+C],1!==c){var S=ve.AttributeCompression.octDecode(De.x,De.y,Be),A=fe.Transforms.eastNorthUpToFixedFrame(Se,s,Ge),P=fe.Matrix4.inverseTransformation(A,Fe);fe.Matrix4.multiplyByPointAsVector(P,S,S),S.z*=c,Ee.Cartesian3.normalize(S,S),fe.Matrix4.multiplyByPointAsVector(A,S,S),Ee.Cartesian3.normalize(S,S),ve.AttributeCompression.octEncode(S,De)}}i.hasWebMercatorT&&(M=(we.WebMercatorProjection.geodeticLatitudeToMercatorAngle(We.latitude)-u)*l),t=i.encode(e,t,x,b,We.height,De,M)}}function Oe(e,t){var r;return"function"==typeof e.slice&&"function"!=typeof(r=e.slice()).sort&&(r=void 0),Te.defined(r)||(r=Array.prototype.slice.call(e)),r.sort(t),r}return o(function(e,t){var r,i,n=e.quantizedVertices,o=n.length/3,a=e.octEncodedNormals,s=e.westIndices.length+e.eastIndices.length+e.southIndices.length+e.northIndices.length,d=e.includeWebMercatorT,h=Ee.Rectangle.clone(e.rectangle),c=h.west,u=h.south,l=h.east,I=h.north,m=Ee.Ellipsoid.clone(e.ellipsoid),g=e.exaggeration,T=e.minimumHeight*g,p=e.maximumHeight*g,E=e.relativeToCenter,f=fe.Transforms.eastNorthUpToFixedFrame(E,m),v=fe.Matrix4.inverseTransformation(f,new fe.Matrix4);d&&(r=we.WebMercatorProjection.geodeticLatitudeToMercatorAngle(u),i=1/(we.WebMercatorProjection.geodeticLatitudeToMercatorAngle(I)-r));var y=n.subarray(0,o),w=n.subarray(o,2*o),N=n.subarray(2*o,3*o),b=Te.defined(a),M=new Array(o),x=new Array(o),C=new Array(o),S=d?new Array(o):[],A=Ae;A.x=Number.POSITIVE_INFINITY,A.y=Number.POSITIVE_INFINITY,A.z=Number.POSITIVE_INFINITY;var P=Pe;P.x=Number.NEGATIVE_INFINITY,P.y=Number.NEGATIVE_INFINITY,P.z=Number.NEGATIVE_INFINITY;for(var W=Number.POSITIVE_INFINITY,D=Number.NEGATIVE_INFINITY,B=Number.POSITIVE_INFINITY,F=Number.NEGATIVE_INFINITY,G=0;G<o;++G){var k=y[G],_=w[G],O=k/Ce,V=_/Ce,Y=pe.CesiumMath.lerp(T,p,N[G]/Ce);We.longitude=pe.CesiumMath.lerp(c,l,O),We.latitude=pe.CesiumMath.lerp(u,I,V),We.height=Y,W=Math.min(We.longitude,W),D=Math.max(We.longitude,D),B=Math.min(We.latitude,B),F=Math.max(We.latitude,F);var H=m.cartographicToCartesian(We);M[G]=new Ee.Cartesian2(O,V),x[G]=Y,C[G]=H,d&&(S[G]=(we.WebMercatorProjection.geodeticLatitudeToMercatorAngle(We.latitude)-r)*i),fe.Matrix4.multiplyByPoint(v,H,Se),Ee.Cartesian3.minimumByComponent(Se,A,A),Ee.Cartesian3.maximumByComponent(Se,P,P)}var R,z,U,L=Oe(e.westIndices,function(e,t){return M[e].y-M[t].y}),j=Oe(e.eastIndices,function(e,t){return M[t].y-M[e].y}),q=Oe(e.southIndices,function(e,t){return M[t].x-M[e].x}),Q=Oe(e.northIndices,function(e,t){return M[e].x-M[t].x});1!==g&&(z=fe.BoundingSphere.fromPoints(C),R=be.OrientedBoundingBox.fromRectangle(h,T,p,m)),(1!==g||T<0)&&(U=new Me.EllipsoidalOccluder(m).computeHorizonCullingPointPossiblyUnderEllipsoid(E,C,T));var K=T;K=Math.min(K,ke(e.westIndices,e.westSkirtHeight,x,M,h,m,v,A,P)),K=Math.min(K,ke(e.southIndices,e.southSkirtHeight,x,M,h,m,v,A,P)),K=Math.min(K,ke(e.eastIndices,e.eastSkirtHeight,x,M,h,m,v,A,P)),K=Math.min(K,ke(e.northIndices,e.northSkirtHeight,x,M,h,m,v,A,P));for(var X=new Ne.AxisAlignedBoundingBox(A,P,E),Z=new Me.TerrainEncoding(X,K,p,f,b,d),J=Z.getStride(),$=new Float32Array(o*J+s*J),ee=0,te=0;te<o;++te){if(b){var re=2*te;if(De.x=a[re],De.y=a[1+re],1!==g){var ie=ve.AttributeCompression.octDecode(De.x,De.y,Be),ne=fe.Transforms.eastNorthUpToFixedFrame(C[te],m,Ge),oe=fe.Matrix4.inverseTransformation(ne,Fe);fe.Matrix4.multiplyByPointAsVector(oe,ie,ie),ie.z*=g,Ee.Cartesian3.normalize(ie,ie),fe.Matrix4.multiplyByPointAsVector(ne,ie,ie),Ee.Cartesian3.normalize(ie,ie),ve.AttributeCompression.octEncode(ie,De)}}ee=Z.encode($,ee,C[te],M[te],x[te],De,S[te])}var ae=Math.max(0,2*(s-4)),se=e.indices.length+3*ae,de=ye.IndexDatatype.createTypedArray(o+s,se);de.set(e.indices,0);var he=1e-4*(D-W),ce=1e-4*(F-B),ue=-he,le=he,Ie=ce,me=-ce,ge=o*J;return _e($,ge,L,Z,x,M,a,m,h,e.westSkirtHeight,g,r,i,ue,0),_e($,ge+=e.westIndices.length*J,q,Z,x,M,a,m,h,e.southSkirtHeight,g,r,i,0,me),_e($,ge+=e.southIndices.length*J,j,Z,x,M,a,m,h,e.eastSkirtHeight,g,r,i,le,0),_e($,ge+=e.eastIndices.length*J,Q,Z,x,M,a,m,h,e.northSkirtHeight,g,r,i,0,Ie),xe.addSkirtIndices(L,q,j,Q,o,de,e.indices.length),t.push($.buffer,de.buffer),{vertices:$.buffer,indices:de.buffer,westIndicesSouthToNorth:L,southIndicesEastToWest:q,eastIndicesNorthToSouth:j,northIndicesWestToEast:Q,vertexStride:J,center:E,minimumHeight:T,maximumHeight:p,boundingSphere:z,orientedBoundingBox:R,occludeePointInScaledSpace:U,encoding:Z,indexCountWithoutSkirts:e.indices.length}})});
